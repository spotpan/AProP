import torch
#from hitsgnn import HITSGNN
from hitsgnn_rev2 import HITSGNN
from utils import *
import argparse
import numpy as np
from metattack import MetaApprox, Metattack
import torch.nn.functional as F
import torch.optim as optim
import seaborn as sns
from matplotlib import pyplot as plt
import pandas as pd

parser = argparse.ArgumentParser()
parser.add_argument('--seed', type=int, default=18, help='Random seed.')
parser.add_argument('--epochs', type=int, default=200,
                    help='Number of epochs to train.')
parser.add_argument('--lr', type=float, default=0.01,
                    help='Initial learning rate.')
parser.add_argument('--hidden', type=int, default=16,
                    help='Number of hidden units.')
parser.add_argument('--dataset', type=str, default='cora',
                    choices=['cora', 'cora_ml', 'citeseer', 'polblogs'], help='dataset')
parser.add_argument('--ptb_rate', type=float, default=0.09,  help='pertubation rate')
parser.add_argument('--model', type=str, default='Meta-Self', choices=['A-Meta-Self', 'Meta-Self'], help='model variant')

args = parser.parse_args()
cuda = torch.cuda.is_available()
device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")

np.random.seed(args.seed)
torch.manual_seed(args.seed)
if device != 'cpu':
    torch.cuda.manual_seed(args.seed)

# === loading dataset
adj, features, labels = load_data(dataset=args.dataset)
nclass = max(labels) + 1

val_size = 0.1
test_size = 0.8
train_size = 1 - test_size - val_size

idx = np.arange(adj.shape[0])
idx_train, idx_val, idx_test = get_train_val_test(idx, train_size, val_size, test_size, stratify=labels)


print("idx_test", type(idx_test))


idx_test1=[0, 2050, 2051, 4, 2052, 5, 2053, 2057, 10, 2059, 14, 2067, 21, 23, 27, 2075, 2077, 2078, 31, 2079, 2081, 2083, 36, 2084, 39, 40, 43, 44, 2091, 2096, 51, 52, 53, 2099, 58, 2110, 63, 64, 65, 67, 68, 2117, 2118, 2119, 69, 2121, 2123, 2124, 78, 2127, 2129, 80, 84, 85, 87, 2136, 92, 94, 2143, 97, 98, 2148, 2149, 2150, 102, 2152, 110, 2159, 112, 2161, 116, 2165, 2166, 118, 2178, 131, 129, 135, 136, 2188, 142, 143, 144, 145, 2194, 2198, 151, 2202, 157, 2209, 161, 163, 164, 2210, 2215, 2216, 170, 2218, 2219, 172, 174, 2224, 179, 2226, 2229, 2228, 2234, 186, 190, 2239, 2240, 2241, 2244, 2246, 2247, 200, 2248, 2250, 2257, 2261, 2265, 218, 221, 2270, 2269, 224, 229, 233, 2281, 235, 2287, 241, 2290, 245, 247, 253, 2302, 256, 257, 2306, 2307, 2308, 261, 262, 258, 266, 2315, 2318, 2319, 267, 2322, 2323, 2324, 278, 2326, 2328, 281, 282, 2332, 2333, 285, 2336, 2338, 2339, 2340, 297, 299, 2347, 301, 2348, 2354, 309, 313, 314, 2364, 316, 318, 2376, 330, 331, 2380, 2382, 334, 2386, 2388, 341, 353, 354, 2403, 358, 2411, 365, 368, 370, 372, 373, 374, 375, 2427, 380, 381, 382, 2428, 2432, 385, 390, 394, 396, 397, 398, 2446, 2444, 400, 406, 410, 412, 2461, 2462, 2464, 417, 2463, 421, 424, 2473, 426, 2472, 428, 2477, 429, 2480, 435, 2484, 438, 2483, 445, 451, 452, 459, 460, 461, 464, 466, 468, 471, 474, 475, 476, 478, 479, 481, 482, 483, 484, 493, 494, 496, 502, 504, 505, 506, 508, 510, 512, 517, 520, 521, 522, 526, 528, 531, 533, 537, 538, 542, 544, 546, 547, 548, 554, 560, 563, 564, 565, 568, 569, 572, 573, 578, 579, 581, 586, 587, 588, 590, 595, 596, 597, 601, 602, 605, 613, 615, 617, 626, 631, 637, 641, 642, 644, 646, 651, 659, 667, 669, 670, 671, 672, 674, 675, 679, 680, 685, 688, 692, 694, 702, 703, 704, 705, 706, 708, 711, 713, 714, 717, 720, 721, 724, 728, 731, 737, 738, 739, 742, 744, 745, 748, 749, 752, 755, 757, 758, 762, 764, 765, 767, 769, 774, 775, 776, 777, 781, 782, 784, 790, 795, 796, 797, 798, 806, 810, 813, 814, 824, 838, 844, 860, 865, 866, 870, 872, 875, 876, 880, 885, 890, 891, 892, 911, 912, 916, 938, 944, 946, 964, 968, 972, 973, 974, 975, 977, 978, 1000, 1004, 1015, 1029, 1034, 1048, 1051, 1052, 1057, 1060, 1068, 1071, 1072, 1084, 1085, 1091, 1093, 1096, 1097, 1100, 1103, 1116, 1118, 1119, 1122, 1123, 1124, 1131, 1133, 1134, 1136, 1147, 1148, 1151, 1152, 1155, 1160, 1165, 1169, 1174, 1187, 1197, 1201, 1205, 1207, 1209, 1211, 1219, 1225, 1234, 1239, 1240, 1243, 1248, 1249, 1251, 1256, 1265, 1266, 1282, 1285, 1286, 1287, 1292, 1305, 1309, 1313, 1319, 1324, 1332, 1333, 1357, 1361, 1362, 1363, 1364, 1365, 1366, 1367, 1376, 1378, 1382, 1388, 1391, 1393, 1394, 1395, 1399, 1406, 1415, 1428, 1433, 1446, 1447, 1451, 1455, 1456, 1458, 1459, 1461, 1469, 1472, 1478, 1479, 1489, 1490, 1491, 1494, 1499, 1504, 1511, 1512, 1518, 1530, 1532, 1535, 1536, 1538, 1542, 1543, 1547, 1558, 1561, 1563, 1573, 1585, 1587, 1592, 1600, 1601, 1602, 1604, 1607, 1609, 1610, 1616, 1620, 1621, 1623, 1624, 1625, 1627, 1630, 1631, 1632, 1633, 1642, 1643, 1644, 1651, 1661, 1662, 1673, 1679, 1682, 1683, 1693, 1695, 1696, 1698, 1699, 1705, 1710, 1713, 1715, 1718, 1719, 1725, 1736, 1740, 1741, 1745, 1754, 1759, 1762, 1763, 1771, 1772, 1773, 1780, 1781, 1783, 1784, 1785, 1786, 1793, 1808, 1815, 1818, 1819, 1831, 1834, 1835, 1838, 1839, 1840, 1841, 1851, 1862, 1863, 1866, 1867, 1876, 1878, 1879, 1880, 1881, 1884, 1886, 1888, 1890, 1892, 1894, 1895, 1897, 1901, 1902, 1911, 1914, 1918, 1929, 1931, 1932, 1935, 1936, 1938, 1944, 1946, 1947, 1950, 1954, 1955, 1960, 1961, 1964, 1966, 1967, 1968, 1974, 1982, 1984, 1986, 1987, 1988, 1990, 1993, 1997, 2000, 2007, 2009, 2012, 2015, 2016, 2024, 2037]

idx_test2=[2048, 2052, 2053, 12, 13, 2064, 2067, 20, 2068, 21, 2072, 23, 29, 30, 31, 32, 34, 2083, 2084, 42, 44, 2095, 2096, 49, 52, 2101, 57, 2104, 2105, 58, 61, 62, 2120, 2121, 2127, 2128, 2129, 2130, 2131, 2136, 2139, 2148, 2149, 2151, 2152, 2153, 2154, 2155, 2165, 2166, 2171, 2174, 2178, 2179, 2180, 2181, 2182, 2184, 2186, 2190, 2193, 2197, 2212, 2213, 2215, 2216, 2218, 2228, 2231, 2232, 2236, 2237, 2238, 2073, 2240, 2244, 2246, 2247, 202, 2255, 2256, 2077, 2264, 2266, 2267, 2274, 2275, 2281, 2283, 2284, 2287, 2288, 2289, 2290, 2292, 2300, 2301, 2302, 2311, 2313, 2315, 2318, 2321, 2322, 2324, 2326, 2332, 2333, 2336, 2346, 2352, 2354, 2359, 2360, 2365, 2366, 2369, 2370, 2371, 2372, 2377, 2380, 2381, 2383, 2384, 2386, 2387, 2390, 2392, 2393, 2399, 2406, 2422, 2428, 2431, 2432, 2444, 2452, 2455, 2457, 2461, 2466, 2469, 422, 2474, 2476, 2477, 2484, 638, 640, 683, 804, 807, 808, 810, 811, 812, 813, 814, 815, 826, 833, 838, 840, 844, 846, 849, 850, 852, 855, 856, 857, 860, 861, 862, 864, 866, 869, 871, 872, 873, 875, 876, 877, 892, 896, 897, 904, 907, 911, 914, 917, 925, 929, 931, 932, 933, 934, 938, 941, 942, 948, 952, 959, 961, 963, 964, 965, 966, 968, 972, 975, 978, 983, 986, 987, 989, 990, 991, 1000, 1005, 1013, 1023, 1024, 1039, 1042, 1046, 1048, 1050, 1052, 1057, 1062, 1069, 1070, 1074, 1079, 1080, 1084, 1085, 1086, 1091, 1093, 1095, 1096, 1098, 1100, 1102, 1110, 1119, 1121, 1122, 1123, 1124, 1126, 1128, 1129, 1131, 1132, 1135, 1140, 1146, 1147, 1148, 1149, 1151, 1159, 1162, 1165, 1168, 1169, 1173, 1177, 1179, 1184, 1187, 1189, 1192, 1193, 1202, 1204, 1205, 1209, 1210, 1221, 1230, 1234, 1237, 1242, 1250, 1255, 1256, 1259, 1265, 1271, 1276, 1281, 1282, 1287, 1288, 1291, 1292, 1296, 1299, 1302, 1305, 1309, 1310, 1313, 1314, 1316, 1328, 1336, 1338, 1347, 1348, 1353, 1358, 1361, 1364, 1369, 1370, 1374, 1375, 1381, 1382, 1386, 1388, 1391, 1393, 1394, 1395, 1396, 1401, 1403, 1407, 1420, 1422, 1425, 1427, 1428, 1429, 1432, 1433, 1434, 1436, 1450, 1451, 1452, 1454, 1456, 1460, 1465, 1467, 1469, 1476, 1478, 1479, 1482, 1483, 1489, 1490, 1491, 1493, 1494, 1495, 1496, 1499, 1500, 1501, 1504, 1508, 1509, 1510, 1512, 1513, 1523, 1527, 1532, 1534, 1535, 1536, 1538, 1542, 1548, 1558, 1566, 1567, 1570, 1572, 1574, 1576, 1577, 1581, 1585, 1593, 1597, 1601, 1602, 1606, 1609, 1610, 1621, 1623, 1624, 1625, 1626, 1630, 1632, 1644, 1645, 1651, 1654, 1660, 1661, 1667, 1677, 1678, 1684, 1686, 1688, 1693, 1694, 1696, 1697, 1699, 1700, 1711, 1715, 1716, 1721, 1732, 1736, 1738, 1739, 1743, 1746, 1750, 1754, 1755, 1758, 1759, 1763, 1772, 1773, 1774, 1780, 1781, 1783, 1786, 1788, 1789, 1793, 1797, 1798, 1802, 1804, 1811, 1813, 1814, 1816, 1817, 1818, 1819, 1820, 1824, 1825, 1831, 1832, 1835, 1836, 1837, 1838, 1839, 1854, 1858, 1864, 1873, 1874, 1880, 1882, 1883, 1890, 1892, 1894, 1895, 1896, 1900, 1901, 1903, 1906, 1921, 1929, 1933, 1934, 1945, 1950, 1957, 1962, 1970, 1976, 1989, 1990, 1992, 1997, 1999, 2000, 2001, 2003, 2005, 2007, 2009, 2012, 2034, 2036, 2039, 2047]

idx_test3=[0, 4, 5, 6, 9, 10, 13, 14, 18, 19, 23, 25, 27, 29, 30, 31, 35, 39, 40, 42, 43, 44, 48, 49, 50, 51, 52, 53, 54, 58, 63, 68, 69, 71, 72, 74, 75, 78, 80, 83, 84, 85, 87, 89, 90, 91, 92, 94, 95, 97, 98, 102, 103, 107, 108, 110, 111, 112, 113, 116, 118, 120, 121, 122, 124, 126, 128, 131, 132, 135, 136, 137, 139, 140, 142, 143, 144, 145, 148, 149, 150, 151, 152, 153, 154, 157, 160, 161, 164, 165, 168, 169, 170, 179, 180, 182, 183, 184, 186, 187, 188, 191, 193, 196, 200, 202, 203, 204, 210, 211, 212, 218, 221, 222, 225, 228, 229, 230, 232, 233, 235, 236, 238, 241, 247, 250, 253, 255, 256, 257, 258, 261, 262, 266, 267, 269, 270, 271, 272, 273, 275, 278, 282, 284, 285, 286, 287, 288, 289, 291, 296, 297, 299, 300, 301, 305, 309, 312, 313, 314, 316, 317, 318, 321, 328, 330, 331, 334, 336, 343, 345, 347, 353, 354, 356, 357, 358, 359, 360, 365, 367, 368, 369, 370, 373, 374, 375, 377, 380, 381, 382, 386, 388, 389, 390, 393, 398, 399, 402, 404, 405, 406, 407, 411, 412, 416, 418, 420, 421, 422, 424, 426, 427, 428, 429, 433, 436, 445, 446, 447, 451, 452, 455, 456, 457, 458, 462, 464, 465, 466, 467, 471, 472, 473, 474, 475, 476, 479, 480, 482, 483, 484, 485, 486, 487, 490, 491, 493, 495, 497, 503, 505, 507, 508, 509, 512, 513, 514, 517, 518, 519, 520, 522, 523, 526, 528, 531, 533, 534, 536, 537, 538, 539, 540, 541, 542, 543, 544, 545, 546, 547, 548, 549, 550, 551, 552, 553, 554, 556, 558, 561, 562, 567, 568, 569, 570, 572, 573, 575, 577, 578, 579, 581, 583, 586, 588, 589, 590, 593, 594, 595, 597, 598, 599, 602, 603, 604, 605, 610, 614, 615, 617, 620, 621, 622, 624, 625, 626, 628, 631, 632, 636, 641, 642, 643, 644, 645, 647, 648, 651, 652, 654, 655, 657, 658, 659, 664, 665, 666, 667, 668, 672, 674, 675, 676, 678, 679, 680, 684, 685, 687, 688, 692, 693, 694, 695, 696, 702, 703, 704, 705, 706, 708, 711, 712, 713, 717, 721, 722, 725, 729, 731, 733, 734, 736, 737, 738, 739, 742, 743, 744, 745, 746, 747, 748, 749, 751, 752, 753, 754, 755, 757, 758, 759, 760, 765, 767, 769, 771, 772, 773, 775, 776, 781, 782, 783, 784, 791, 792, 795, 796, 797, 798, 800, 803, 804, 806, 810, 811, 813, 814, 817, 818, 821, 822, 826, 828, 829, 830, 835, 838, 840, 841, 842, 843, 844, 845, 847, 849, 851, 852, 853, 856, 857, 860, 862, 863, 866, 875, 876, 877, 885, 886, 888, 889, 890, 891, 892, 899, 900, 903, 906, 907, 909, 914, 916, 932, 934, 935, 937, 938, 940, 944, 946, 948, 949, 951, 956, 962, 964, 965, 966, 968, 972, 973, 974, 975, 979, 980, 987, 990, 993, 995, 996, 998, 1000, 1001, 1002, 1003, 1004, 1005, 1009, 1013, 1014, 1015, 1016, 1017, 1018, 1019, 1021, 1027, 1029, 1034, 1036, 1037, 1038, 1040, 1047, 1048, 1051, 1057, 1060, 1061, 1062, 1064, 1067, 1068, 1071, 1072, 1075, 1077, 1080, 1085, 1087, 1091, 1093, 1096, 1099, 1100, 1101, 1103, 1106, 1109, 1116, 1122, 1123, 1124, 1129, 1131, 1132, 1133, 1134, 1136, 1139, 1143, 1151, 1155, 1158, 1160, 1164, 1165, 1167, 1168, 1169, 1174, 1179, 1182, 1184, 1186, 1187, 1188, 1190, 1191, 1193, 1194, 1197, 1199, 1201, 1207, 1208, 1209, 1213, 1214, 1215, 1217, 1218, 1222, 1223, 1233, 1234, 1237, 1239, 1240, 1242, 1243, 1244, 1249, 1251, 1252, 1256, 1257, 1259, 1260, 1271, 1272, 1273, 1274, 1275, 1277, 1278, 1279, 1282, 1283, 1284, 1285, 1288, 1292, 1303, 1305, 1306, 1309, 1310, 1314, 1319, 1332, 1333, 1345, 1346, 1347, 1348, 1353, 1361, 1362, 1363, 1364, 1366, 1369, 1370, 1372, 1375, 1376, 1377, 1378, 1384, 1388, 1391, 1393, 1394, 1395, 1396, 1399, 1401, 1406, 1407, 1417, 1419, 1423, 1425, 1427, 1428, 1429, 1431, 1432, 1433, 1434, 1438, 1439, 1442, 1446, 1447, 1448, 1450, 1451, 1453, 1455, 1456, 1458, 1459, 1460, 1461, 1463, 1466, 1467, 1471, 1472, 1474, 1478, 1479, 1485, 1489, 1490, 1491, 1493, 1494, 1498, 1499, 1508, 1511, 1517, 1518, 1519, 1520, 1525, 1527, 1529, 1530, 1532, 1534, 1535, 1536, 1537, 1538, 1539, 1540, 1544, 1546, 1547, 1548, 1551, 1556, 1557, 1558, 1559, 1561, 1563, 1566, 1569, 1570, 1573, 1574, 1575, 1576, 1582, 1585, 1586, 1587, 1592, 1596, 1597, 1599, 1600, 1601, 1602, 1609, 1610, 1616, 1617, 1618, 1619, 1620, 1621, 1623, 1624, 1627, 1629, 1630, 1631, 1632, 1633, 1635, 1636, 1641, 1642, 1645, 1647, 1651, 1652, 1653, 1655, 1657, 1661, 1662, 1663, 1666, 1667, 1670, 1673, 1678, 1679, 1681, 1682, 1683, 1685, 1688, 1690, 1691, 1692, 1693, 1695, 1696, 1697, 1698, 1699, 1705, 1709, 1710, 1711, 1713, 1715, 1719, 1721, 1725, 1729, 1732, 1734, 1736, 1740, 1741, 1742, 1745, 1746, 1750, 1752, 1754, 1756, 1758, 1759, 1760, 1762, 1763, 1764, 1765, 1766, 1767, 1770, 1771, 1773, 1774, 1777, 1783, 1784, 1792, 1793, 1798, 1803, 1805, 1806, 1807, 1808, 1814, 1815, 1816, 1817, 1820, 1826, 1827, 1828, 1830, 1831, 1834, 1835, 1837, 1838, 1839, 1840, 1841, 1844, 1851, 1852, 1859, 1860, 1861, 1862, 1867, 1873, 1874, 1876, 1878, 1879, 1880, 1881, 1882, 1884, 1886, 1887, 1888, 1892, 1894, 1895, 1897, 1901, 1902, 1909, 1910, 1911, 1918, 1919, 1920, 1921, 1923, 1924, 1925, 1927, 1929, 1930, 1931, 1932, 1935, 1936, 1938, 1940, 1945, 1947, 1950, 1954, 1955, 1960, 1961, 1964, 1966, 1967, 1968, 1970, 1974, 1978, 1979, 1982, 1984, 1986, 1987, 1988, 1989, 1990, 1992, 1997, 1999, 2000, 2002, 2003, 2004, 2006, 2007, 2009, 2011, 2012, 2019, 2027, 2029, 2031, 2032, 2033, 2034, 2037, 2038, 2040, 2041, 2042, 2045, 2050, 2051, 2052, 2053, 2056, 2057, 2059, 2060, 2066, 2067, 2074, 2075, 2076, 2077, 2083, 2084, 2096, 2098, 2099, 2103, 2109, 2110, 2114, 2115, 2117, 2118, 2119, 2123, 2124, 2127, 2128, 2129, 2131, 2135, 2136, 2137, 2139, 2143, 2144, 2148, 2149, 2150, 2152, 2155, 2156, 2157, 2160, 2161, 2163, 2164, 2169, 2171, 2172, 2178, 2179, 2187, 2188, 2192, 2194, 2197, 2198, 2199, 2200, 2201, 2202, 2203, 2213, 2214, 2215, 2216, 2218, 2219, 2220, 2222, 2224, 2226, 2228, 2229, 2230, 2233, 2234, 2240, 2242, 2244, 2246, 2247, 2248, 2250, 2253, 2257, 2258, 2261, 2263, 2265, 2269, 2275, 2277, 2281, 2284, 2287, 2290, 2294, 2300, 2302, 2308, 2311, 2313, 2315, 2316, 2318, 2319, 2322, 2323, 2324, 2326, 2327, 2328, 2333, 2336, 2337, 2338, 2339, 2341, 2342, 2347, 2354, 2355, 2357, 2359, 2361, 2363, 2364, 2366, 2367, 2369, 2370, 2371, 2376, 2380, 2381, 2382, 2386, 2387, 2388, 2389, 2390, 2395, 2397, 2399, 2405, 2406, 2408, 2410, 2411, 2413, 2414, 2420, 2424, 2427, 2428, 2432, 2433, 2436, 2437, 2438, 2440, 2442, 2444, 2446, 2448, 2450, 2451, 2452, 2459, 2460, 2462, 2463, 2465, 2467, 2469, 2471, 2472, 2473, 2474, 2475, 2476, 2477, 2478, 2480, 2483, 2484]

idx_test4=[2051, 13, 14, 2064, 2066, 2073, 2077, 31, 2083, 2084, 42, 2096, 57, 59, 58, 2109, 62, 61, 2113, 65, 2128, 2136, 2170, 2171, 2181, 2184, 2185, 2190, 2197, 2210, 2212, 2215, 2228, 2244, 2247, 2275, 2281, 2284, 2287, 2290, 2311, 2313, 2315, 2321, 2322, 2326, 2331, 2332, 2344, 2345, 2346, 2359, 2360, 2361, 2365, 2366, 2370, 2371, 2381, 2390, 2392, 2393, 2396, 2399, 2402, 2405, 2406, 2422, 2428, 2460, 2461, 2468, 2469, 422, 2477, 2484, 638, 642, 683, 692, 808, 810, 812, 815, 828, 838, 840, 844, 849, 852, 853, 854, 857, 866, 869, 872, 877, 902, 904, 906, 907, 925, 927, 929, 930, 933, 938, 953, 965, 976, 983, 994, 1001, 1005, 1016, 1019, 1024, 1042, 1063, 1064, 1080, 1086, 1101, 1102, 1110, 1121, 1128, 1132, 1141, 1159, 1162, 1169, 1172, 1177, 1179, 1182, 1184, 1185, 1188, 1189, 1192, 1193, 1209, 1210, 1234, 1255, 1256, 1271, 1272, 1273, 1282, 1288, 1299, 1309, 1313, 1315, 1338, 1346, 1347, 1350, 1364, 1370, 1372, 1375, 1381, 1393, 1394, 1395, 1396, 1401, 1412, 1420, 1430, 1443, 1445, 1449, 1454, 1465, 1471, 1490, 1491, 1495, 1499, 1504, 1523, 1548, 1558, 1567, 1569, 1570, 1572, 1576, 1578, 1586, 1591, 1597, 1601, 1602, 1606, 1623, 1624, 1626, 1645, 1650, 1654, 1667, 1678, 1688, 1689, 1699, 1700, 1709, 1710, 1715, 1716, 1721, 1730, 1737, 1739, 1746, 1775, 1777, 1783, 1788, 1797, 1804, 1813, 1820, 1821, 1826, 1828, 1835, 1839, 1853, 1860, 1861, 1864, 1887, 1894, 1920, 1921, 1970, 1997, 2000, 2001, 2003, 2004, 2005, 2007, 2012, 2043, 2045, 2047]

idx_test5=[0, 2050, 2051, 2052, 2053, 2057, 2058, 2059, 2060, 2056, 18, 2067, 19, 21, 23, 2073, 2075, 27, 29, 2078, 31, 2079, 36, 39, 40, 43, 44, 2091, 2089, 42, 48, 49, 52, 53, 58, 2117, 2119, 2123, 2124, 78, 2127, 2129, 2136, 89, 2139, 92, 94, 2144, 97, 2148, 2149, 2150, 2152, 104, 2157, 2161, 2165, 2166, 119, 120, 129, 132, 135, 139, 142, 143, 2192, 145, 2194, 149, 144, 2199, 2202, 2203, 154, 156, 2207, 161, 163, 164, 2215, 2216, 168, 169, 2224, 2226, 179, 2228, 2229, 184, 2234, 187, 2241, 2242, 2246, 2247, 200, 2248, 2250, 206, 2257, 211, 212, 218, 2269, 233, 2281, 238, 2287, 253, 2302, 255, 257, 266, 267, 2318, 2319, 273, 2322, 275, 2324, 272, 278, 2328, 284, 285, 2337, 2338, 2341, 297, 298, 299, 304, 305, 2354, 2356, 309, 2361, 2366, 2369, 324, 330, 2380, 2384, 2386, 2390, 348, 354, 356, 357, 365, 2413, 370, 2420, 373, 374, 378, 2428, 381, 2437, 392, 393, 2444, 400, 403, 2454, 411, 412, 2461, 2462, 420, 421, 422, 2469, 2474, 2475, 428, 429, 2478, 2477, 426, 433, 430, 2476, 445, 447, 451, 456, 464, 471, 474, 475, 476, 478, 482, 483, 484, 487, 491, 493, 494, 495, 497, 502, 503, 507, 508, 514, 515, 516, 517, 520, 522, 523, 528, 531, 537, 542, 546, 547, 548, 549, 554, 556, 557, 558, 560, 568, 570, 575, 579, 586, 588, 590, 593, 595, 602, 605, 622, 626, 632, 634, 637, 641, 642, 643, 645, 647, 652, 657, 658, 659, 660, 674, 675, 676, 681, 685, 688, 696, 702, 703, 704, 706, 708, 712, 716, 717, 720, 723, 725, 728, 731, 739, 744, 748, 755, 757, 758, 769, 775, 776, 777, 781, 784, 792, 795, 796, 797, 802, 804, 806, 810, 813, 814, 824, 828, 856, 857, 860, 865, 866, 870, 871, 878, 884, 888, 890, 907, 911, 914, 916, 942, 951, 963, 964, 965, 966, 968, 972, 990, 993, 994, 1000, 1009, 1015, 1019, 1048, 1057, 1062, 1068, 1069, 1072, 1075, 1080, 1087, 1100, 1101, 1103, 1119, 1122, 1131, 1134, 1136, 1148, 1151, 1155, 1160, 1165, 1168, 1169, 1174, 1184, 1186, 1197, 1201, 1209, 1211, 1237, 1249, 1251, 1256, 1259, 1260, 1265, 1271, 1272, 1282, 1285, 1287, 1292, 1305, 1309, 1319, 1333, 1353, 1361, 1364, 1366, 1370, 1376, 1378, 1382, 1391, 1393, 1394, 1395, 1405, 1415, 1423, 1425, 1427, 1432, 1433, 1434, 1446, 1447, 1450, 1455, 1458, 1460, 1467, 1469, 1472, 1476, 1478, 1479, 1485, 1489, 1491, 1493, 1511, 1518, 1525, 1530, 1532, 1535, 1536, 1543, 1547, 1557, 1558, 1566, 1573, 1587, 1592, 1601, 1602, 1605, 1609, 1610, 1620, 1621, 1624, 1625, 1626, 1629, 1630, 1631, 1632, 1633, 1642, 1657, 1661, 1662, 1667, 1673, 1675, 1678, 1679, 1683, 1691, 1693, 1696, 1697, 1698, 1713, 1718, 1719, 1721, 1725, 1729, 1732, 1736, 1741, 1746, 1747, 1750, 1752, 1754, 1758, 1759, 1762, 1763, 1773, 1774, 1780, 1783, 1793, 1795, 1805, 1806, 1816, 1818, 1819, 1827, 1830, 1831, 1835, 1838, 1839, 1840, 1841, 1862, 1867, 1873, 1874, 1878, 1879, 1886, 1892, 1894, 1895, 1897, 1902, 1910, 1911, 1929, 1930, 1935, 1938, 1940, 1945, 1947, 1954, 1955, 1960, 1961, 1964, 1974, 1979, 1988, 1989, 1999, 2003, 2004, 2009, 2016, 2019, 2033, 2034, 2037, 2038]

idx_test6=[13, 2063, 2067, 20, 2073, 2074, 2077, 31, 32, 2083, 2088, 42, 2096, 2098, 57, 58, 65, 2137, 2139, 2143, 2149, 2156, 2161, 2170, 2171, 2174, 2179, 2180, 2181, 2184, 2185, 2186, 2197, 2210, 2215, 2216, 2218, 2228, 2232, 2236, 2246, 2247, 2258, 2275, 2300, 2311, 2326, 2346, 2348, 2352, 2354, 2359, 2360, 2361, 2366, 2370, 2371, 2381, 2390, 2392, 2393, 2398, 2406, 2411, 2422, 2431, 2432, 2467, 422, 638, 642, 683, 807, 812, 828, 838, 844, 849, 850, 851, 853, 855, 856, 860, 861, 862, 866, 877, 899, 902, 903, 904, 905, 915, 925, 929, 932, 933, 938, 940, 941, 942, 948, 959, 962, 973, 978, 979, 982, 983, 989, 1005, 1007, 1009, 1013, 1018, 1019, 1023, 1024, 1042, 1046, 1050, 1061, 1062, 1063, 1071, 1080, 1101, 1102, 1110, 1121, 1122, 1127, 1131, 1132, 1140, 1141, 1157, 1159, 1160, 1164, 1175, 1177, 1179, 1185, 1188, 1189, 1192, 1209, 1210, 1237, 1241, 1244, 1255, 1256, 1259, 1265, 1271, 1272, 1273, 1282, 1284, 1288, 1289, 1291, 1292, 1299, 1302, 1313, 1325, 1328, 1336, 1338, 1347, 1348, 1350, 1360, 1370, 1374, 1375, 1384, 1393, 1394, 1398, 1400, 1410, 1420, 1427, 1430, 1465, 1476, 1489, 1491, 1499, 1504, 1512, 1513, 1519, 1523, 1526, 1527, 1532, 1540, 1581, 1591, 1593, 1597, 1601, 1606, 1609, 1610, 1624, 1644, 1653, 1654, 1660, 1667, 1675, 1677, 1680, 1688, 1699, 1706, 1709, 1710, 1715, 1716, 1732, 1736, 1739, 1746, 1752, 1754, 1755, 1760, 1766, 1783, 1788, 1797, 1799, 1804, 1806, 1807, 1813, 1820, 1821, 1824, 1825, 1827, 1828, 1836, 1837, 1838, 1851, 1852, 1853, 1854, 1864, 1873, 1881, 1883, 1887, 1894, 1900, 1918, 1921, 1960, 1970, 1976, 1994, 1997, 2000, 2001, 2005, 2007, 2010, 2015, 2020, 2023, 2029, 2033, 2038, 2045, 2047]
#print("adj.shape[0]",adj.shape[0])
idx_test7=[2063, 20, 2073, 32, 2088, 57, 2170, 2174, 2180, 2181, 2184, 2185, 2186, 2232, 2236, 2346, 2352, 2360, 2392, 2393, 2398, 2422, 2431, 638, 683, 807, 812, 850, 855, 861, 902, 904, 905, 915, 925, 929, 933, 941, 942, 959, 982, 983, 989, 1007, 1023, 1024, 1042, 1046, 1050, 1063, 1102, 1110, 1121, 1127, 1140, 1141, 1157, 1159, 1175, 1177, 1185, 1189, 1192, 1210, 1241, 1255, 1289, 1291, 1299, 1302, 1325, 1328, 1336, 1338, 1350, 1360, 1374, 1398, 1400, 1410, 1420, 1430, 1465, 1476, 1513, 1523, 1526, 1581, 1591, 1593, 1606, 1654, 1660, 1675, 1677, 1680, 1706, 1716, 1739, 1755, 1788, 1797, 1799, 1804, 1813, 1821, 1824, 1825, 1836, 1853, 1854, 1864, 1883, 1900, 1976, 1994, 2001, 2005, 2010, 2020, 2023, 2047]

#idx_test8=[2064, 2073, 57, 59, 62, 61, 2113, 2170, 2181, 2184, 2185, 2190, 2212, 2321, 2331, 2344, 2345, 2346, 2360, 2365, 2392, 2393, 2396, 2402, 2422, 2468, 638, 683, 808, 812, 815, 854, 869, 902, 904, 925, 927, 929, 930, 933, 953, 976, 983, 994, 1024, 1042, 1063, 1086, 1102, 1110, 1121, 1128, 1141, 1159, 1162, 1172, 1177, 1185, 1189, 1192, 1210, 1255, 1299, 1315, 1338, 1350, 1381, 1412, 1420, 1430, 1443, 1445, 1449, 1454, 1465, 1495, 1523, 1567, 1572, 1578, 1591, 1606, 1626, 1650, 1654, 1689, 1700, 1716, 1730, 1737, 1739, 1775, 1788, 1797, 1804, 1813, 1821, 1853, 1864, 2001, 2005, 2043, 2047]

idx_test8=[0, 2050, 4, 2052, 5, 2053, 2057, 10, 2059, 21, 23, 27, 2075, 2078, 2079, 2081, 36, 39, 40, 43, 44, 2091, 51, 52, 53, 2099, 2110, 63, 64, 67, 68, 2117, 2118, 2119, 69, 2121, 2123, 2124, 78, 2127, 2129, 80, 84, 85, 87, 92, 94, 97, 98, 2148, 2150, 102, 2152, 110, 2159, 112, 116, 2165, 2166, 118, 2178, 131, 129, 135, 136, 2188, 142, 143, 144, 145, 2194, 2198, 151, 2202, 157, 2209, 161, 163, 164, 170, 2219, 172, 174, 2224, 179, 2226, 2229, 2234, 186, 190, 2239, 2240, 2241, 200, 2248, 2250, 2257, 2261, 2265, 218, 221, 2270, 2269, 224, 229, 233, 235, 241, 245, 247, 253, 2302, 256, 257, 2306, 2307, 2308, 261, 262, 258, 266, 2318, 2319, 267, 2323, 2324, 278, 2328, 281, 282, 2333, 285, 2336, 2338, 2339, 2340, 297, 299, 2347, 301, 309, 313, 314, 2364, 316, 318, 2376, 330, 331, 2380, 2382, 334, 2386, 2388, 341, 353, 354, 2403, 358, 365, 368, 370, 372, 373, 374, 375, 2427, 380, 381, 382, 385, 390, 394, 396, 397, 398, 2446, 2444, 400, 406, 410, 412, 2462, 2464, 417, 2463, 421, 424, 2473, 426, 2472, 428, 429, 2480, 435, 438, 2483, 445, 451, 452, 459, 460, 461, 464, 466, 468, 471, 474, 475, 476, 478, 479, 481, 482, 483, 484, 493, 494, 496, 502, 504, 505, 506, 508, 510, 512, 517, 520, 521, 522, 526, 528, 531, 533, 537, 538, 542, 544, 546, 547, 548, 554, 560, 563, 564, 565, 568, 569, 572, 573, 578, 579, 581, 586, 587, 588, 590, 595, 596, 597, 601, 602, 605, 613, 615, 617, 626, 631, 637, 641, 644, 646, 651, 659, 667, 669, 670, 671, 672, 674, 675, 679, 680, 685, 688, 694, 702, 703, 704, 705, 706, 708, 711, 713, 714, 717, 720, 721, 724, 728, 731, 737, 738, 739, 742, 744, 745, 748, 749, 752, 755, 757, 758, 762, 764, 765, 767, 769, 774, 775, 776, 777, 781, 782, 784, 790, 795, 796, 797, 798, 806, 813, 814, 824, 865, 870, 875, 876, 880, 885, 890, 891, 892, 911, 912, 916, 944, 946, 964, 968, 972, 974, 975, 977, 1000, 1004, 1015, 1029, 1034, 1048, 1051, 1052, 1057, 1060, 1068, 1072, 1084, 1085, 1091, 1093, 1096, 1097, 1100, 1103, 1116, 1118, 1119, 1123, 1124, 1133, 1134, 1136, 1147, 1148, 1151, 1152, 1155, 1165, 1174, 1187, 1197, 1201, 1205, 1207, 1211, 1219, 1225, 1239, 1240, 1243, 1248, 1249, 1251, 1266, 1285, 1286, 1287, 1305, 1319, 1324, 1332, 1333, 1357, 1361, 1362, 1363, 1365, 1366, 1367, 1376, 1378, 1382, 1388, 1391, 1399, 1406, 1415, 1428, 1433, 1446, 1447, 1451, 1455, 1456, 1458, 1459, 1461, 1469, 1472, 1478, 1479, 1494, 1511, 1518, 1530, 1535, 1536, 1538, 1542, 1543, 1547, 1561, 1563, 1573, 1585, 1587, 1592, 1600, 1604, 1607, 1616, 1620, 1621, 1625, 1627, 1630, 1631, 1632, 1633, 1642, 1643, 1651, 1661, 1662, 1673, 1679, 1682, 1683, 1693, 1695, 1696, 1698, 1705, 1713, 1718, 1719, 1725, 1740, 1741, 1745, 1759, 1762, 1763, 1771, 1772, 1773, 1780, 1781, 1784, 1785, 1786, 1793, 1808, 1815, 1818, 1819, 1831, 1834, 1840, 1841, 1862, 1863, 1866, 1867, 1876, 1878, 1879, 1880, 1884, 1886, 1888, 1890, 1892, 1895, 1897, 1901, 1902, 1911, 1914, 1929, 1931, 1932, 1935, 1936, 1938, 1944, 1946, 1947, 1950, 1954, 1955, 1961, 1964, 1966, 1967, 1968, 1974, 1982, 1984, 1986, 1987, 1988, 1990, 1993, 2009, 2016, 2024, 2037]

idx_test=np.array(idx_test8)

#idx_test=idx_test1

idx_unlabeled = np.union1d(idx_val, idx_test)



perturbations = int(args.ptb_rate * (adj.sum()//2))

adj, features, labels = preprocess(adj, features, labels, preprocess_adj=False)



# set up attack model
if 'Self' in args.model:
    lambda_ = 0
if 'Train' in args.model:
    lambda_ = 1
if 'Both' in args.model:
    lambda_ = 0.5

if 'A' in args.model:
    model = MetaApprox(nfeat=features.shape[1], hidden_sizes=[args.hidden],
                       nnodes=adj.shape[0], nclass=nclass, dropout=0.5,
                       train_iters=100, attack_features=False, lambda_=lambda_, device=device)

else:
    model = Metattack(nfeat=features.shape[1], hidden_sizes=[args.hidden],
                       nnodes=adj.shape[0], nclass=nclass, dropout=0.5,
                       train_iters=100, attack_features=False, lambda_=lambda_, device=device)

if device != 'cpu':
    adj = adj.to(device)
    features = features.to(device)
    labels = labels.to(device)
    model = model.to(device)


def test(adj):
    ''' test on HITSGNN '''

    adj = normalize_adj_tensor(adj)
    hitsgnn = HITSGNN(nfeat=features.shape[1],
              nhid=args.hidden,
              nclass=labels.max().item() + 1,
              dropout=0.5)

    if device != 'cpu':
        hitsgnn = hitsgnn.to(device)

    optimizer = optim.Adam(hitsgnn.parameters(),
                           lr=args.lr, weight_decay=5e-4)

    hitsgnn.train()

    for epoch in range(args.epochs):
        optimizer.zero_grad()
        output = hitsgnn(features, adj)
        loss_train = F.nll_loss(output[idx_train], labels[idx_train])
        acc_train = accuracy(output[idx_train], labels[idx_train])
        loss_train.backward()
        optimizer.step()

    hitsgnn.eval()
    output = hitsgnn(features, adj)


    loss_test = F.nll_loss(output[idx_test], labels[idx_test])
    acc_test = accuracy(output[idx_test], labels[idx_test])


    # print("Test set results:",
    #       "loss= {:.4f}".format(loss_test.item()),
    #       "accuracy= {:.4f}".format(acc_test.item()))

    return acc_test.item()


def main():

    acc = []
    runs = 1
    
    for i in range(runs):
        acc.append(test(adj))

    torch.cuda.empty_cache()

    #for i in range(3):
    
    modified_adj = model(features, adj, labels, idx_train,
                            idx_unlabeled, perturbations, ll_constraint=False)
    modified_adj = modified_adj.detach()

    for i in range(runs):
        acc.append(test(modified_adj))

    print("acc",acc)



    #data=pd.DataFrame({"Acc. Clean":clean_acc,"Acc. Perturbed":attacked_acc})

    #plt.figure(figsize=(6,6))
    #sns.boxplot(data=data)#, re_trainings*[accuracy_logistic]])

    #plt.title("Accuracy before/after perturbing {}% edges using model {}".format(args.ptb_rate*100, args.model))
    #plt.savefig("results_on_{}.png".format(args.dataset), dpi=600)
    #plt.show()


if __name__ == '__main__':
    main()

#neighbor type 0:
#acc [0.8158953722334005, 0.7228370221327969, 0.6443661971830986, 0.579476861167002]

#neighbor type 1:
#acc [0.837138508371385, 0.7671232876712328, 0.7625570776255708, 0.7519025875190258]

#neighbor type 2:
#acc [0.8158914728682171, 0.7887596899224806, 0.7829457364341085, 0.7810077519379844]

#neighbor type 3:
#acc [0.8181026979982593, 0.7510879025239339, 0.7232375979112271, 0.7154046997389034]

#neighbor type 4:
#acc [0.8181818181818181, 0.7470355731225296, 0.7114624505928854, 0.7035573122529644]

#neighbor type 5:
#acc [0.8424015009380863, 0.7279549718574109, 0.6679174484052532, 0.6697936210131332]

#neighbor type 6:
#acc [0.8309859154929577, 0.8133802816901409, 0.7852112676056339, 0.8169014084507042]

#neighbor type 7:
#acc [0.7622950819672132, 0.7295081967213115, 0.6721311475409837, 0.6885245901639344]

#neighbor type 8:
#acc [0.8155339805825242, 0.7669902912621358, 0.6990291262135921, 0.6699029126213591]

#neighbor type 8-0:
#acc [0.8333333333333334, 0.6953405017921147, 0.6881720430107527, 0.6738351254480287]

